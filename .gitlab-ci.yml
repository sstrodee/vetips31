stages:
  - build
  - deploy

build_job:
  stage: build
  tags: [build-runner]
  only: [main]
  script:
    - |
      set -e
      echo "üëÆ‚Äç‚ôÇÔ∏è –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ GitLab Registry"
      echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"

      IMAGE="$CI_REGISTRY_IMAGE:latest"   # <registry>/<group>/<project>:latest
      echo "üì¶ –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞: $IMAGE"
      docker build -t "$IMAGE" .

      echo "üöö –ü—É—à –æ–±—Ä–∞–∑–∞"
      echo "IMAGE=$CI_REGISTRY_IMAGE:latest"
      docker push "$IMAGE"

deploy_job:
  stage: deploy
  tags: [build-runner]
  only: [main]
  script:
    - |
      set -e
      echo "üëÆ‚Äç‚ôÇÔ∏è –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ GitLab Registry"
      echo "$CI_REGISTRY_READ_TOKEN" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"

      IMAGE="$CI_REGISTRY_IMAGE:latest"
      echo "üîé –ü—Ä–æ–≤–µ—Ä—è—é –¥–æ—Å—Ç—É–ø –∫ $IMAGE"
      docker pull "$IMAGE"

      echo "üöÄ –î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
      docker compose up -d --remove-orphans --force-recreate